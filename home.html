<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <!--Using google maps api, implementation based on documentation here  https://developers.google.com/maps/documentation/javascript/tutorial-->
    <meta charset="utf-8">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script type="text/javascript" src="/socket.io/socket.io.js"></script>
    <script type="text/javascript" src="key.js"></script>
    <title>CS565 Project</title>
    <style>
    #map{
      height: 400px;
      width: 100%;
    }
    </style>
  </head>
  <body>
    <div class="test">
      home htm
    </div>
    <div class=searchContainer>
      <input type="text" id="searchCriteria" name="searchCriteria" placeholder="search" value="park">
      <!-- <input type="submit" id="searchButton" value ="search"> -->
      <button id="searchButton">search</button>
      <button id="geolocation">around me</button>
    </div>
    <button type="button" id="to_results">RESULTS SUBMIT</button>
    <br>
    <div id="map"></div>
    <div id="choicesContainer">
      <select id="choices" size="5">
        <option value="First" selected="selected">Search Results</option>
      </select>
    </div>
  </body>

  <script type="text/javascript">

    // long and lat of the current selected place. default portland
    let lat = 45.5155;
    let long = -122.6793;

    $("#to_results").click(() =>{
      location.href = "results";
    });

    var objectSocket = io.connect("/");

    $('#searchButton').on('click', () => {
      objectSocket.emit('searchData', {
        'query': $("#searchCriteria").val(),
        'lat': 45.5155,
        'long': -122.6793,
        'geo': false
      });
    });

    $('#geolocation').on('click', () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(getCurrent);
      } else {
        alert("current location not found");
      }
    });

    function getCurrent(pos){
      var latitude = pos.coords.latitude;
      var longitude = pos.coords.longitude;
      objectSocket.emit('searchData', {
        'query': 'hike',
        'lat': latitude,
        'long': longitude,
        'geo': true
      });
    }

    objectSocket.on('searchResults', (data) => {
      $("#choices").empty();
      var selectList = $("#choices");
      for(result in data.results)
      {
        var optionValue = data.results[result].geometry.location.lat + "," + data.results[result].geometry.location.lng;
        var choice = $("<option />", {value: optionValue, text: data.results[result].formatted_address});
        selectList.append(choice);
      }
      $("#choices").append(selectList);
      lat = data.results[0].geometry.location.lat;
      long = data.results[0].geometry.location.lng;
      initMap();
    });

    //On change of selection update google map to the selected area
    $("#choices").on('change', () => {
      var newLocation = $("#choices option:selected").val().split(',');
      lat = Number(newLocation[0]);
      long = Number(newLocation[1]);
      initMap();
    });

    initMap = () => {
      var mapOptions = {
        center: {lat: lat, lng:long},
        zoom: 14
      }

      var map = new google.maps.Map(document.getElementById('map'), mapOptions);

      //Add marker
      var marker = new google.maps.Marker({
        position: {lat: lat, lng: long},
        map: map
      });
    }
  </script>

  <script id="mapsScript"src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAt_YlKrQAlnqEYjcaRwUAuAMat60S578E&callback=initMap"
   async defer>
  </script>

</html>
